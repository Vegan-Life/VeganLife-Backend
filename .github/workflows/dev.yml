name: Deploy to Amazon EC2

on:
  push:
    branches: [ "develop", "infra-270-1" ]

# ì½”ë“œì˜ ë‚´ìš©ì„ ì´ íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ actionì„ ìˆ˜í–‰í•˜ëŠ” ì£¼ì²´(Github Actionsì—ì„œ ì‚¬ìš©í•˜ëŠ” VM)ê°€ ì½ì„ ìˆ˜ ìžˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.
permissions:
  contents: read

jobs:
  build:
    name: Build and Push to Docker Repository
    runs-on: ubuntu-latest

    steps:
    # ì§€ì •í•œ ì €ìž¥ì†Œ(í˜„ìž¬ REPO)ì—ì„œ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜¤ë„ë¡ í•˜ëŠ” github action
    - uses: actions/checkout@v3

    # jdk ë°°í¬íŒ ì„¤ì •
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: "corretto"

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0

    - name: Grant execute permission for gradlew
      run: | 
        chmod +x gradlew

    - name: Build with Gradle Wrapper
      env:
        MARIA_URL: ${{ secrets.MARIA_URL }}
        MARIA_USER: ${{ secrets.MARIA_USER }}
        MARIA_PASSWORD: ${{ secrets.MARIA_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        ./gradlew clean build

    # Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ ë¹Œë“œ
    - name: Docker Build
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker build -f docker/Dockerfile -t ${{ secrets.DOCKER_REPO }}/veganlife-dev .

    # Docker hubì— ì—…ë¡œë“œ
    - name: Push to Docker Repo
      run: |
        docker push ${{ secrets.DOCKER_REPO }}/veganlife-dev

    - name: Send Notification to Discord - Failure
      if: failure()  # ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
      run: |
        curl -X POST -H 'Content-Type: application/json' -d '{"content": "Build ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.ðŸ¥º"}' $DISCORD_WEBHOOK_URL
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

  deploy:
    needs: build
    name: Deploy Server via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Configure SSH
        run: |
          echo "Configure SSH"
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/veganlife-dev.key
          chmod 600 ~/.ssh/veganlife-dev.key
          cat >>~/.ssh/config <<END
          Host veganlife-dev
            HostName $SSH_HOST
            User $SSH_USERNAME
            IdentityFile ~/.ssh/veganlife-dev.key
            StrictHostKeyChecking no
          END
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Docker Compose Down
        # home ê¸°ì¤€ ì‹¤í–‰íŒŒì¼ì˜ ìƒëŒ€ê²½ë¡œë¥¼ ì ì–´ì£¼ì–´ì•¼ í•œë‹¤.
        run: |
          echo "Docker Compose Down"
          ssh veganlife-dev 'docker compose -f veganlife-dev/docker-compose.yml down --rmi all'

      - name: Set Docker Networks
        run: |
          echo "Set Docker Networks"
          ssh veganlife-dev 'docker network rm deploy'
          ssh veganlife-dev 'docker network create deploy'

      - name: Docker Compose Up
        run: |
          echo "Docker Compose Up"
          ssh veganlife-dev 'docker compose -f veganlife-dev/docker-compose.yml up -d'

      - name: Clear
        run: |
          echo "Clear"
          ssh veganlife-dev 'docker system prune -a'

      - name: Send Notification to Discord - Failure
        if: failure()  # ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
        run: |
          curl -X POST -H 'Content-Type: application/json' -d '{"content": "ë°°í¬ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.ðŸ¥º"}' $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

  healthcheck:
    needs: [build, deploy]
    name: Server Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Health Check
        run: |
          attempt_count=10
          for ((i=1; i<=$attempt_count; i++)); do
              response=$(curl -IsS --max-time 5 "$DEV_HEALTHCHECK_URL" | head -n 1 | cut -d$' ' -f2)
              if [ "$response" == "200" ]; then
                  echo "í—¬ìŠ¤ ì²´í¬ ì„±ê³µ - HTTP ìƒíƒœì½”ë“œ: $response"
                  exit 0
              else
                  echo "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - HTTP ìƒíƒœì½”ë“œ: $response"
              fi
              sleep 3
          done

          echo "í—¬ìŠ¤ ì²´í¬ $attempt_countíšŒ ì‹œë„ ì¤‘ ì‹¤íŒ¨"
          exit 1
        env:
          DEV_HEALTHCHECK_URL: ${{ secrets.DEV_HEALTHCHECK_URL }}

      - name: Send Notification to Discord - Success
        if: success()  # ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
        run: |
          curl -X POST -H 'Content-Type: application/json' -d '{"content": "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!ðŸ˜„"}' $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send Notification to Discord - Failure
        if: failure()  # ë°°í¬ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
        run: |
          curl -X POST -H 'Content-Type: application/json' -d '{"content": "Health Check ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.ðŸ¥º"}' $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
